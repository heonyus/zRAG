# Phase 4: Multi-hop Extension
# 목표: Multi-hop QA 성능 및 한계 분석

model:
  llm_name: "Qwen/Qwen3-8B"
  quantization: "4bit"
  lora:
    r: 64
    alpha: 128
    target_modules: ["q_proj", "v_proj", "k_proj", "o_proj"]
    dropout: 0.05

parametric_qa:
  num_docs: 50000
  z_dim: 256
  m_tokens: 8
  selection_method: "learned_router"

data:
  dataset: "hotpot_qa"
  setting: "distractor"  # 8 noise + 2 gold
  train_samples: null
  eval_samples: null  # full dev set (7405)
  max_doc_length: 512
  max_query_length: 256  # longer for multi-hop

multihop:
  strategies:
    - name: "concat"
      description: "Multiple z_i concatenation (single selection)"
      top_k: 10
    - name: "iterative"
      description: "Iterative selection: z1 → partial → z2"
      max_hops: 3
      top_k_per_hop: 5
    - name: "linked"
      description: "Write-time linking between related z_i"
      link_threshold: 0.7

write_phase:
  epochs: 50
  lr: 1e-3
  llm_frozen: true
  batch_size: 8

read_phase:
  epochs: 3
  lr_llm: 2e-5
  lr_z: 1e-3
  lr_proj: 1e-4
  alpha_retrieval: 0.1
  batch_size: 2
  gradient_accumulation: 8
  warmup_ratio: 0.1

evaluation:
  metrics: ["em", "f1", "supporting_fact_f1", "joint_em", "bridge_entity_recall"]
  seeds: [42, 123, 456]

analysis:
  error_categories:
    - "bridge_not_found"     # z selection 실패
    - "bridge_not_recognized" # z 정보 encoding 실패
    - "propagation_error"    # multi-step reasoning 실패
  visualization:
    - "tsne_z_clusters"
    - "hop_wise_recall"
    - "error_distribution"

hardware:
  device: "cuda"
  fp16: true
  gradient_checkpointing: true

logging:
  project: "parametric-qa"
  run_name: "phase4-multihop"
  use_wandb: true
  log_dir: "./logs/phase4"
  save_dir: "./checkpoints/phase4"
